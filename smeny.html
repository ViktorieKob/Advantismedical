<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Úprava směn</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    nav {
      background-color: #0057a0;
      padding: 10px;
      margin: -20px -20px 20px -20px;
    }

    nav a {
      color: white;
      margin-right: 20px;
      text-decoration: none;
    }

    h2 {
      margin-top: 40px;
    }

    .smestr-sekce {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .smestr-blok {
      flex: 1;
      min-width: 350px;
    }

    .smena-box {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #e9f3ff;
    }

    .pacient-row {
      margin-top: 10px;
    }

    select, input[type="time"], input[type="text"], button {
      margin: 5px;
      padding: 5px;
      font-size: 15px;
    }

    .historie-label {
      margin-top: 30px;
      font-size: 18px;
      font-weight: bold;
      color: #666;
    }

    .separator {
      margin-top: 40px;
      border-top: 2px solid #999;
    }
  </style>
</head>
<body>
  <nav>
    <a href="dashboard.html">Moje směny</a>
    <a href="zadosti.html">Žádosti</a>
    <a href="planovani.html">Plánování směn</a>
    <a href="smeny.html">Úprava směn</a>
  </nav>

  <h2>Úprava směn</h2>
  <div id="smenyContainer"></div>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4j1bO7JDbzUM-ca4AWUSkGYpmglWK_IQ",
      authDomain: "dochazka-app.firebaseapp.com",
      projectId: "dochazka-app",
      storageBucket: "dochazka-app.appspot.com",
      messagingSenderId: "912220280247",
      appId: "1:912220280247:web:e0b27491b9234cba984432"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const pacienti = [];

    function formatDatum(datum) {
      return datum.split("-").reverse().join(".");
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("Přístup pouze pro přihlášené uživatele.");
        window.location.href = "index.html";
        return;
      }

      const container = document.getElementById("smenyContainer");
      const dnes = new Date().toISOString().split("T")[0];

      db.collection("pacienti").get().then(snapshot => {
        snapshot.forEach(doc => pacienti.push(doc.data().jmeno));

        db.collection("smeny").orderBy("od").get().then(snapshot => {
          const smeny = {};
          snapshot.forEach(doc => {
            const d = doc.data();
            const email = d.email;
            if (!smeny[email]) smeny[email] = { aktualni: [], historie: [] };
            const cil = (d.od < dnes) ? smeny[email].historie : smeny[email].aktualni;
            cil.push({ id: doc.id, data: d });
          });

          for (const email in smeny) {
            const blok = document.createElement("div");
            blok.className = "smestr-blok";
            blok.innerHTML = `<h3>${email}</h3>`;

            const aktualni = smeny[email].aktualni.map(smena => vytvorSmenuBox(smena.id, smena.data));
            const historie = smeny[email].historie.map(smena => vytvorSmenuBox(smena.id, smena.data, true));

            aktualni.forEach(box => blok.appendChild(box));

            if (historie.length) {
              const sep = document.createElement("div");
              sep.className = "separator";
              blok.appendChild(sep);
              const hLabel = document.createElement("div");
              hLabel.className = "historie-label";
              hLabel.textContent = "Historie směn";
              blok.appendChild(hLabel);
              historie.forEach(box => blok.appendChild(box));
            }

            container.appendChild(blok);
          }
        });
      });
    });

    function vytvorSmenuBox(id, data, zamceno = false) {
      const box = document.createElement("div");
      box.className = "smena-box";

      const nadpis = document.createElement("h4");
      nadpis.innerHTML = `${formatDatum(data.od)}`;
      box.appendChild(nadpis);

      const pacientiDiv = document.createElement("div");

      (data.pacienti || []).forEach((p, i) => {
        pacientiDiv.appendChild(vytvorPacientRadek(id, i, p.jmeno, p.cas, p.komentar, zamceno));
      });

      if (!zamceno) {
        const pridejBtn = document.createElement("button");
        pridejBtn.textContent = "Přidat pacienta";
        pridejBtn.addEventListener("click", () => {
          pacientiDiv.appendChild(vytvorPacientRadek(id, pacientiDiv.childElementCount));
        });
        box.appendChild(pridejBtn);
      }

      box.appendChild(pacientiDiv);
      return box;
    }

    function vytvorPacientRadek(docId, index, vychoziJmeno = "", vychoziCas = "", vychoziKomentar = "", zamceno = false) {
      const row = document.createElement("div");
      row.className = "pacient-row";

      const select = document.createElement("select");
      pacienti.forEach(jmeno => {
        const option = document.createElement("option");
        option.value = jmeno;
        option.textContent = jmeno;
        if (jmeno === vychoziJmeno) option.selected = true;
        select.appendChild(option);
      });

      const time = document.createElement("input");
      time.type = "time";
      time.value = vychoziCas;

      const komentar = document.createElement("input");
      komentar.type = "text";
      komentar.placeholder = "Komentář";
      komentar.value = vychoziKomentar;

      const ulozit = document.createElement("button");
      ulozit.textContent = "Uložit";
      ulozit.addEventListener("click", () => {
        ulozPacient(docId, index, select.value, time.value, komentar.value);
      });

      if (zamceno) {
        select.disabled = true;
        time.disabled = true;
        komentar.disabled = true;
        ulozit.style.display = "none";
      }

      row.appendChild(select);
      row.appendChild(time);
      row.appendChild(komentar);
      row.appendChild(ulozit);
      return row;
    }

    function ulozPacient(docId, index, jmeno, cas, komentar) {
      const docRef = db.collection("smeny").doc(docId);
      docRef.get().then(doc => {
        if (!doc.exists) return;
        let data = doc.data();
        if (!Array.isArray(data.pacienti)) data.pacienti = [];
        data.pacienti[index] = { jmeno, cas, komentar, ulozeno: true };
        docRef.update({ pacienti: data.pacienti })
          .then(() => alert("Uloženo"))
          .catch(err => alert("Chyba při ukládání: " + err));
      });
    }
  </script>
</body>
</html>
