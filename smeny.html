<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Úprava směn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    nav {
      background-color: #0057a0;
      padding: 10px;
      margin: -20px -20px 20px -20px;
    }
    nav a {
      color: white;
      margin-right: 20px;
      text-decoration: none;
    }
    .smena-box {
      background-color: #e8f0fe;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .smena-header {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .pacient-radek {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    select, input[type="time"], input[type="text"] {
      padding: 6px;
      font-size: 14px;
    }
    button {
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <a href="dashboard.html">Moje směny</a>
    <a href="zadosti.html">Žádosti</a>
    <a href="planovani.html">Plánování směn</a>
    <a href="smeny.html">Úprava směn</a>
  </nav>

  <h2>Úprava směn</h2>
  <div id="smenyContainer"></div>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4j1bO7JDbzUM-ca4AWUSkGYpmglWK_IQ",
      authDomain: "dochazka-app.firebaseapp.com",
      projectId: "dochazka-app",
      storageBucket: "dochazka-app.appspot.com",
      messagingSenderId: "912220280247",
      appId: "1:912220280247:web:e0b27491b9234cba984432"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const pacienti = ["Paseková", "Dragoun", "Žáková", "Chmarníková", "Drbohlavová"];
    const smenyContainer = document.getElementById("smenyContainer");

    auth.onAuthStateChanged(user => {
      if (user) {
        nactiSmeny();
      } else {
        alert("Přístup pouze pro přihlášené uživatele.");
        window.location.href = "index.html";
      }
    });

    async function nactiSmeny() {
      const snapshot = await db.collection("smeny").get();
      let smeny = [];

      snapshot.forEach(doc => {
        const d = doc.data();
        smeny.push({ id: doc.id, ...d });
      });

      smeny.sort((a, b) => new Date(a.od) - new Date(b.od));
      smenyContainer.innerHTML = "";

      smeny.forEach(smena => {
        const box = document.createElement("div");
        box.className = "smena-box";

        const datumText = smena.od === smena.do ? smena.od : `${smena.od} – ${smena.do}`;
        box.innerHTML = `<div class="smena-header">${datumText} (<b>${smena.email}</b>)</div>`;

        const pacientiDiv = document.createElement("div");
        pacientiDiv.id = `pacienti-${smena.id}`;

        const radek = vytvorPacientRadek(smena.id, smena.pacienti || []);
        pacientiDiv.appendChild(radek);

        const btn = document.createElement("button");
        btn.textContent = "Přidat pacienta";
        btn.onclick = () => {
          pacientiDiv.appendChild(vytvorPacientRadek(smena.id));
        };

        box.appendChild(pacientiDiv);
        box.appendChild(btn);
        smenyContainer.appendChild(box);
      });
    }

    function vytvorPacientRadek(smenaId, data = {}) {
      const radek = document.createElement("div");
      radek.className = "pacient-radek";

      const select = document.createElement("select");
      select.innerHTML = `<option value="">— vybrat —</option>` +
        pacienti.map(jmeno => `<option value="${jmeno}" ${data.jmeno === jmeno ? "selected" : ""}>${jmeno}</option>`).join("");

      const casInput = document.createElement("input");
      casInput.type = "time";
      casInput.value = data.cas || "";

      const koment = document.createElement("input");
      koment.type = "text";
      koment.placeholder = "Komentář";
      koment.value = data.komentar || "";

      const ulozBtn = document.createElement("button");
      ulozBtn.textContent = "Uložit";
      ulozBtn.onclick = async () => {
        const jmeno = select.value;
        const cas = casInput.value;
        const komentar = koment.value;

        if (!jmeno || !cas) {
          alert("Vyplňte prosím pacienta i čas.");
          return;
        }

        const docRef = db.collection("smeny").doc(smenaId);
        const docSnap = await docRef.get();
        const data = docSnap.data();
        const seznam = data.pacienti || [];
        seznam.push({ jmeno, cas, komentar });
        await docRef.update({ pacienti: seznam });
        alert("Pacient přidán.");
      };

      radek.appendChild(select);
      radek.appendChild(casInput);
      radek.appendChild(koment);
      radek.appendChild(ulozBtn);
      return radek;
    }
  </script>
</body>
</html>
