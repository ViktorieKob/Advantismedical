<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Úprava směn</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    nav {
      background-color: #0057a0;
      padding: 10px;
      margin: -20px -20px 20px -20px;
    }

    nav a {
      color: white;
      margin-right: 20px;
      text-decoration: none;
    }

    .smena-box {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      background-color: #e9f3ff;
    }

    .pacient-row {
      margin-top: 10px;
    }

    select, input[type="time"], input[type="text"], button {
      margin: 5px;
      padding: 5px;
      font-size: 16px;
    }

    .historie-box {
      background-color: #f2f2f2;
      padding: 10px;
      border-radius: 10px;
      margin-top: 30px;
    }

    .smazat-btn {
      background-color: #ff4d4d;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <a href="dashboard.html">Moje směny</a>
    <a href="zadosti.html">Žádosti</a>
    <a href="planovani.html">Plánování směn</a>
    <a href="smeny.html">Úprava směn</a>
  </nav>

  <h2>Úprava směn</h2>
  <div id="smenyContainer"></div>
  <div class="historie-box">
    <h3>Historie směn</h3>
    <div id="historieContainer"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4j1bO7JDbzUM-ca4AWUSkGYpmglWK_IQ",
      authDomain: "dochazka-app.firebaseapp.com",
      projectId: "dochazka-app",
      storageBucket: "dochazka-app.appspot.com",
      messagingSenderId: "912220280247",
      appId: "1:912220280247:web:e0b27491b9234cba984432",
      measurementId: "G-G8PPKTK907"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let seznamPacientu = [];

    function nactiPacienty() {
      return db.collection("pacienti").get().then(snapshot => {
        seznamPacientu = snapshot.docs.map(doc => doc.data().jmeno);
      });
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("Přístup pouze pro přihlášené uživatele.");
        window.location.href = "index.html";
        return;
      }

      const dnes = new Date();
      const smenyContainer = document.getElementById("smenyContainer");
      const historieContainer = document.getElementById("historieContainer");

      nactiPacienty().then(() => {
        db.collection("smeny").orderBy("od").get().then(snapshot => {
          snapshot.forEach(doc => {
            const smena = doc.data();
            const datum = new Date(smena.od);
            const box = document.createElement("div");
            box.className = "smena-box";
            const nadpis = document.createElement("h3");
            nadpis.textContent = `${smena.od} (${smena.email})`;
            box.appendChild(nadpis);

            const pacientiDiv = document.createElement("div");

            if (Array.isArray(smena.pacienti)) {
              smena.pacienti.forEach((pacient, index) => {
                pacientiDiv.appendChild(vytvorPacientRadek(doc.id, index, pacient.jmeno, pacient.cas, pacient.komentar, smena.email, smena.od));
              });
            }

            const pridejBtn = document.createElement("button");
            pridejBtn.textContent = "Přidat pacienta";
            pridejBtn.addEventListener("click", () => {
              pacientiDiv.appendChild(vytvorPacientRadek(doc.id, pacientiDiv.childElementCount, "", "", "", smena.email, smena.od));
            });

            box.appendChild(pacientiDiv);
            if (datum >= dnes) {
              box.appendChild(pridejBtn);
              smenyContainer.appendChild(box);
            } else {
              historieContainer.appendChild(box);
            }
          });
        });
      });
    });

    function vytvorPacientRadek(docId, index, vychoziJmeno = "", vychoziCas = "", vychoziKomentar = "", email, datum) {
      const row = document.createElement("div");
      row.className = "pacient-row";

      const select = document.createElement("select");
      seznamPacientu.forEach(jmeno => {
        const option = document.createElement("option");
        option.value = jmeno;
        option.textContent = jmeno;
        if (jmeno === vychoziJmeno) option.selected = true;
        select.appendChild(option);
      });

      const time = document.createElement("input");
      time.type = "time";
      time.step = 60;
      time.value = vychoziCas;

      const komentar = document.createElement("input");
      komentar.type = "text";
      komentar.placeholder = "Komentář";
      komentar.value = vychoziKomentar;

      const ulozit = document.createElement("button");
      ulozit.textContent = vychoziJmeno && vychoziCas && vychoziKomentar ? "Upravit" : "Uložit";

      const smazat = document.createElement("button");
      smazat.textContent = "Smazat";
      smazat.className = "smazat-btn";

      const disableFields = () => {
        select.disabled = true;
        time.disabled = true;
        komentar.disabled = true;
        ulozit.textContent = "Upravit";
      };

      const enableFields = () => {
        select.disabled = false;
        time.disabled = false;
        komentar.disabled = false;
        ulozit.textContent = "Uložit";
      };

      if (vychoziJmeno && vychoziCas && vychoziKomentar) {
        disableFields();
      }

      ulozit.addEventListener("click", () => {
        if (ulozit.textContent === "Upravit") {
          enableFields();
        } else {
          const docRef = db.collection("smeny").doc(docId);
          docRef.get().then(doc => {
            if (!doc.exists) return;

            let data = doc.data();
            if (!Array.isArray(data.pacienti)) data.pacienti = [];

            data.pacienti[index] = { jmeno: select.value, cas: time.value, komentar: komentar.value };
            docRef.update({ pacienti: data.pacienti })
              .then(() => {
                disableFields();
              })
              .catch(err => alert("Chyba při ukládání: " + err));
          });
        }
      });

      smazat.addEventListener("click", () => {
        const docRef = db.collection("smeny").doc(docId);
        docRef.get().then(doc => {
          if (!doc.exists) return;

          let data = doc.data();
          if (!Array.isArray(data.pacienti)) return;

          data.pacienti.splice(index, 1);
          docRef.update({ pacienti: data.pacienti })
            .then(() => {
              row.remove();
            })
            .catch(err => alert("Chyba při mazání: " + err));
        });
      });

      row.appendChild(select);
      row.appendChild(time);
      row.appendChild(komentar);
      row.appendChild(ulozit);
      row.appendChild(smazat);
      return row;
    }
  </script>
</body>
</html>
