<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    nav {
      background-color: #0057a0;
      padding: 10px;
      margin: -20px -20px 20px -20px;
    }
    nav a {
      color: white;
      margin-right: 20px;
      text-decoration: none;
    }
    #calendar {
      max-width: 900px;
      margin: 0 auto;
    }
    .detail-box, .zadost-box {
      background-color: #f0f0f0;
      margin-top: 20px;
      padding: 10px;
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    select, button {
      font-size: 16px;
      padding: 5px 10px;
      margin-right: 10px;
    }
    @media (hover: none) and (pointer: coarse) {
      .fc-daygrid-day {
        touch-action: manipulation;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a href="dashboard.html">Moje směny</a>
    <a href="zadosti.html">Žádosti</a>
    <a href="planovani.html">Plánování směn</a>
    <a href="smeny.html">Úprava směn</a>
  </nav>

  <h1>Dashboard</h1>
  <div id="calendar"></div>
  <div id="zadostBox" class="zadost-box" style="display:none;"></div>
  <div id="smenyDetail"></div>

  <h3>Seznam naplánovaných pacientů</h3>
  <table id="tabulkaPacientu">
    <thead>
      <tr>
        <th>Datum</th>
        <th>Pacient</th>
        <th>Čas</th>
        <th>Komentář</th>
      </tr>
    </thead>
    <tbody id="pacientiBody"></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4j1bO7JDbzUM-ca4AWUSkGYpmglWK_IQ",
      authDomain: "dochazka-app.firebaseapp.com",
      projectId: "dochazka-app",
      storageBucket: "dochazka-app.appspot.com",
      messagingSenderId: "912220280247",
      appId: "1:912220280247:web:e0b27491b9234cba984432",
      measurementId: "G-G8PPKTK907"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("Musíš být přihlášen.");
        window.location.href = "index.html";
        return;
      }

      let startDate = null;
      let endDate = null;

      const calendarEl = document.getElementById("calendar");
      const detailEl = document.getElementById("smenyDetail");
      const zadostBox = document.getElementById("zadostBox");
      const tbody = document.getElementById("pacientiBody");

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "cs",
        selectable: true,
        select: function(info) {
          startDate = info.startStr;
          const end = new Date(info.end);
          end.setDate(end.getDate() - 1);
          endDate = end.toISOString().split("T")[0];

          zadostBox.style.display = "block";
          zadostBox.innerHTML = `
            <h4>Žádost o volno</h4>
            <p>Od ${startDate} do ${endDate}</p>
            <select id="typVolna">
              <option value="Dovolená">Dovolená</option>
              <option value="Neplacené volno">Neplacené volno</option>
            </select>
            <button onclick="odesliZadost('${startDate}', '${endDate}', '${user.email}')">Požádat</button>
          `;
        },
        headerToolbar: {
          left: "title",
          center: "",
          right: "today prev,next"
        },
        events: [],
        dateClick: function(info) {
          zobrazDetail(info.dateStr, user.email);
        }
      });

      calendar.render();

      function zobrazDetail(datum, email) {
        db.collection("smeny")
          .where("email", "==", email)
          .get()
          .then(snapshot => {
            const data = snapshot.docs.map(doc => doc.data()).filter(smena => smena.od === datum);
            let html = "";
            if (data.length) {
              html += `<div class="detail-box"><h3>${datum.split("-").reverse().join(". ")}</h3>`;
              data.forEach(smena => {
                (smena.pacienti || []).forEach(p => {
                  if (p.jmeno && p.cas && p.komentar) {
                    html += `<p>${p.jmeno} – ${p.cas} – ${p.komentar}</p>`;
                  }
                });
              });
              html += `</div>`;
            } else {
              html += `<div class="detail-box"><p>Žádná směna pro tento den.</p></div>`;
            }
            detailEl.innerHTML = html;
          });
      }

      db.collection("smeny")
        .where("email", "==", user.email)
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const smena = doc.data();
            calendar.addEvent({
              title: "Směna",
              start: smena.od,
              color: "#007bff"
            });

            if (Array.isArray(smena.pacienti)) {
              smena.pacienti.forEach(p => {
                if (p.ulozeno) {
                  const row = document.createElement("tr");
                  row.innerHTML = `
                    <td>${smena.od}</td>
                    <td>${p.jmeno}</td>
                    <td>${p.cas}</td>
                    <td>${p.komentar}</td>
                  `;
                  tbody.appendChild(row);
                }
              });
            }
          });
        });
    });

    function odesliZadost(od, doDatum, email) {
      const typ = document.getElementById("typVolna").value;
      firebase.firestore().collection("zadosti").add({
        od,
        do: doDatum,
        email,
        typ,
        stav: "čeká"
      }).then(() => {
        alert("Žádost byla odeslána.");
        document.getElementById("zadostBox").style.display = "none";
      });
    }
  </script>
</body>
</html>
